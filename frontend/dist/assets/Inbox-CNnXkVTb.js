import{r as a,u as se,a as x,j as e,d as l,f as _,D as ae,e as te,B as w,a5 as re,a6 as le,g as ne,a7 as oe,h as I,i as A,a8 as de,I as j,t as B}from"./index-Og0Cjv7c.js";import{u as ie}from"./useSSE-B_O_Uny5.js";import{E as ce}from"./EmailPanel-eEQInLYz.js";import{C as F}from"./card-DKR6wQjg.js";import{L as b}from"./label-D4adTHT0.js";import{D as me,a as xe,b as he,c as ue,d as pe,e as ge}from"./dialog-CL49OCni.js";import{L as U}from"./loader-circle-qKgIXUvm.js";import{M as fe}from"./mail-COINtWyb.js";import{U as we}from"./user-BczVn2hC.js";import{K as je}from"./key-round-BY18d05u.js";import"./index-BdQq_4o_.js";import"./badge-0u9PLDS-.js";import"./triangle-alert-BALBCSHX.js";import"./trash-2-CFn0c5VE.js";import"./search-C1Z6BGo7.js";function Be(){const[O,q]=a.useState([]),[r,N]=a.useState(null),[T,v]=a.useState([]),[$,i]=a.useState(null),[H,y]=a.useState(!1),[K,C]=a.useState(!1),[Q,R]=a.useState(""),[h,S]=a.useState(0),[J,c]=a.useState(!1),[M,u]=a.useState(""),[m,p]=a.useState(""),[P,g]=a.useState(""),[D,n]=a.useState(""),[f,k]=a.useState(!1),[Y,z]=a.useState(!0),G=se(),o=localStorage.getItem("portal_token");let d="";try{d=JSON.parse(atob((o==null?void 0:o.split(".")[1])||"")).sub||""}catch{}const V=d?d.charAt(0).toUpperCase():"U";ie({endpoint:"/api/sse/portal/events",token:o,enabled:!!o,onEvent:{new_email:()=>{S(s=>s+1),B("New email received",{description:"You have a new message in your inbox.",icon:e.jsx(_,{className:"h-4 w-4"})}),r&&L(r)},stage_change:()=>{}}});const E=a.useCallback(async()=>{try{const s=await x.get("/api/portal/mailboxes");if(q(s.mailboxes),s.mailboxes.length>0){const t=s.mailboxes.find(ee=>ee.name.toLowerCase()==="inbox")||s.mailboxes[0];N(t.id)}}catch{}finally{z(!1)}},[]);async function L(s){y(!0),i(null),S(0);try{const t=await x.get(`/api/portal/mailboxes/${s}/messages?per_page=100`);v(t.data||[])}catch{v([])}finally{y(!1)}}async function W(s){if(r){C(!0);try{const t=await x.get(`/api/portal/mailboxes/${r}/messages/${s}`);i(t)}catch{i(null)}finally{C(!1)}}}async function X(s){if(s.preventDefault(),n(""),m!==P){n("Passwords do not match");return}if(m.length<6){n("Password must be at least 6 characters");return}k(!0);try{await x.post("/api/portal/change-password",{current_password:M,new_password:m}),B.success("Password changed successfully"),u(""),p(""),g(""),c(!1)}catch(t){n(t instanceof Error?t.message:"Failed to change password")}finally{k(!1)}}function Z(){localStorage.removeItem("portal_token"),localStorage.removeItem("portal_refresh_token"),G("/login")}return a.useEffect(()=>{E()},[E]),a.useEffect(()=>{r&&L(r)},[r]),Y?e.jsxs("div",{className:"h-screen flex flex-col bg-dd-100",children:[e.jsx(F,{className:"rounded-none border-x-0 border-t-0 flex-shrink-0",children:e.jsxs("div",{className:"px-4 sm:px-6 py-3 flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(l,{className:"h-8 w-8 rounded-lg"}),e.jsx(l,{className:"h-5 w-32 hidden sm:block"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(l,{className:"h-4 w-40 hidden sm:block"}),e.jsx(l,{className:"h-8 w-8 rounded-full"})]})]})}),e.jsxs("div",{className:"flex flex-1 overflow-hidden",children:[e.jsx("div",{className:"w-52 flex-shrink-0 hidden md:flex flex-col border-r border-dd-200 bg-white p-3 space-y-2",children:Array.from({length:5}).map((s,t)=>e.jsx(l,{className:"h-8 w-full"},t))}),e.jsx("div",{className:"w-80 flex-shrink-0 bg-white border-r border-dd-200 p-3 space-y-3",children:Array.from({length:6}).map((s,t)=>e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(l,{className:"h-3 w-24"}),e.jsx(l,{className:"h-4 w-full"}),e.jsx(l,{className:"h-3 w-16"})]},t))}),e.jsx("div",{className:"flex-1 bg-white flex items-center justify-center",children:e.jsx(U,{className:"h-8 w-8 animate-spin text-dd-400"})})]})]}):e.jsxs("div",{className:"h-screen flex flex-col bg-dd-100",children:[e.jsx(F,{className:"rounded-none border-x-0 border-t-0 flex-shrink-0",children:e.jsxs("div",{className:"px-4 sm:px-6 py-3 flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-dd-red rounded-lg flex items-center justify-center",children:e.jsx(fe,{className:"h-4 w-4 text-white"})}),e.jsx("h1",{className:"text-lg font-bold text-dd-950 hidden sm:block",children:"DasherHelp Mail"}),h>0&&e.jsxs("span",{className:"bg-dd-red text-white text-[10px] font-bold rounded-full px-2 py-0.5 flex items-center gap-1",children:[e.jsx(_,{className:"h-3 w-3"}),h," new"]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-sm text-dd-600 hidden sm:block",children:d}),e.jsxs(ae,{children:[e.jsx(te,{asChild:!0,children:e.jsx(w,{variant:"ghost",className:"h-8 w-8 rounded-full p-0",children:e.jsx(re,{className:"h-8 w-8",children:e.jsx(le,{className:"bg-dd-200 text-dd-700 text-sm font-medium",children:V})})})}),e.jsxs(ne,{align:"end",className:"w-52",children:[e.jsx(oe,{className:"font-normal",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(we,{className:"h-4 w-4 text-dd-500"}),e.jsx("span",{className:"text-sm font-medium text-dd-950 truncate",children:d})]})}),e.jsx(I,{}),e.jsxs(A,{onClick:()=>c(!0),children:[e.jsx(je,{className:"h-4 w-4"}),"Change Password"]}),e.jsx(I,{}),e.jsxs(A,{onClick:Z,className:"text-dd-red focus:text-dd-red",children:[e.jsx(de,{className:"h-4 w-4"}),"Sign Out"]})]})]})]})]})}),e.jsx(ce,{mailboxes:O,activeMailbox:r,onSelectMailbox:N,messages:T,loadingMsgs:H,activeMessage:$,loadingBody:K,onSelectMessage:W,searchQuery:Q,onSearchChange:R,newMailCount:h,onClearMessage:()=>i(null),attachmentBaseUrl:"/api/portal"}),e.jsx(me,{open:J,onOpenChange:s=>{c(s),s||(n(""),u(""),p(""),g(""))},children:e.jsxs(xe,{className:"sm:max-w-sm",children:[e.jsxs(he,{children:[e.jsx(ue,{children:"Change Password"}),e.jsx(pe,{children:"This will also update your email account password."})]}),e.jsxs("form",{onSubmit:X,className:"space-y-4",children:[D&&e.jsx("div",{className:"bg-dd-red-lighter text-dd-red-active p-3 rounded-md text-sm font-medium border border-dd-red/20",children:D}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"current-password",children:"Current Password"}),e.jsx(j,{id:"current-password",type:"password",value:M,onChange:s=>u(s.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"new-password",children:"New Password"}),e.jsx(j,{id:"new-password",type:"password",value:m,onChange:s=>p(s.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"confirm-password",children:"Confirm New Password"}),e.jsx(j,{id:"confirm-password",type:"password",value:P,onChange:s=>g(s.target.value),required:!0})]}),e.jsxs(ge,{className:"gap-2 sm:gap-0",children:[e.jsx(w,{type:"button",variant:"outline",onClick:()=>c(!1),children:"Cancel"}),e.jsxs(w,{type:"submit",disabled:f,className:"bg-dd-red hover:bg-dd-red-hover",children:[f&&e.jsx(U,{className:"h-4 w-4 animate-spin mr-2"}),f?"Changing...":"Change Password"]})]})]})]})})]})}export{Be as default};
