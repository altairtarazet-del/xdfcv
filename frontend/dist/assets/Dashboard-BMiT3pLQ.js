import{c as j,r as c,b as se,u as ae,j as e,d as w,D as te,e as ne,B as d,f as re,g as ce,h as le,i as ie,I as oe,L as de,a as m}from"./index-Og0Cjv7c.js";import{u as me}from"./useSSE-B_O_Uny5.js";import{S as xe,a as L,b as ue,c as he}from"./index-CtgARJQr.js";import{C as z,d as G}from"./card-DKR6wQjg.js";import{B as V}from"./badge-0u9PLDS-.js";import{T as pe,a as ge,b as $,c as g,d as je,e as x}from"./table-BZ65fvGu.js";import{D as fe,a as Ne,b as ye,c as ve,d as we,e as Se}from"./dialog-CL49OCni.js";import{L as _e}from"./loader-circle-qKgIXUvm.js";import{S as be}from"./search-C1Z6BGo7.js";import{C as ke}from"./circle-alert-DC9QC6T-.js";import{C as Ce}from"./clock-DEnkp12q.js";import{U as Ae}from"./user-check-eIhgGQrI.js";/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]],De=j("archive",Ee);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],Ie=j("circle-check",Te);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ze=[["rect",{x:"14",y:"3",width:"5",height:"18",rx:"1",key:"kaeet6"}],["rect",{x:"5",y:"3",width:"5",height:"18",rx:"1",key:"1wsw3u"}]],$e=j("pause",ze);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]],Pe=j("play",Me);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Re=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],Be=j("shield-check",Re);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"17",x2:"22",y1:"8",y2:"13",key:"3nzzx3"}],["line",{x1:"22",x2:"17",y1:"8",y2:"13",key:"1swrse"}]],Ge=j("user-x",Le);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]],Ue=j("zap",Ve),He={REGISTERED:e.jsx(Ae,{className:"h-4 w-4"}),IDENTITY_VERIFIED:e.jsx(Be,{className:"h-4 w-4"}),BGC_PENDING:e.jsx(Ce,{className:"h-4 w-4"}),BGC_CLEAR:e.jsx(Ie,{className:"h-4 w-4"}),BGC_CONSIDER:e.jsx(ke,{className:"h-4 w-4"}),ACTIVE:e.jsx(Ue,{className:"h-4 w-4"}),DEACTIVATED:e.jsx(Ge,{className:"h-4 w-4"})},Fe={critical:"bg-destructive",warning:"bg-yellow-500",info:"bg-blue-500"};function ts(){const[n,U]=c.useState(null),[f,H]=c.useState([]),[M,F]=c.useState(0),[u,k]=c.useState(!1),[t,S]=c.useState(null),[C,A]=se(),[E,P]=c.useState([]),[i,_]=c.useState(new Set),[r,N]=c.useState(null),[O,Y]=c.useState(!0);ae();const o=C.get("stage")||"",y=C.get("search")||"",D=parseInt(C.get("page")||"1"),R=localStorage.getItem("admin_token"),T=localStorage.getItem("admin_role")||"admin",b=T==="operator"||T==="viewer",q=T==="viewer";me({endpoint:"/api/sse/admin/events",token:R,enabled:!!R,onEvent:{new_email:()=>{h(),v()},stage_change:()=>{h(),v()},alert:()=>{h(),I()}}});async function h(){const s=await m.get("/api/dashboard/stats");U(s)}async function v(){const s=new URLSearchParams;o&&s.set("stage",o),y&&s.set("search",y),s.set("page",String(D));const a=await m.get(`/api/dashboard/accounts?${s}`);H(a.accounts),F(a.total)}async function I(){const s=await m.get("/api/dashboard/alerts?unread_only=true&per_page=10");P(s.alerts)}async function K(s){await m.patch(`/api/dashboard/alerts/${s}/read`,{}),I(),h()}async function X(){await m.post("/api/dashboard/alerts/mark-all-read"),P([]),h()}async function Z(){k(!0),S({scanned:0,total:0,errors:0,transitions:0,current_account:"",status:"running"});try{const a=(await m.post("/api/scan")).scan_id,l=setInterval(async()=>{const p=await m.get(`/api/scan/${a}`);S({scanned:p.scanned,total:p.total_accounts||0,errors:p.errors,transitions:p.transitions,current_account:p.current_account||"",status:p.status}),p.status!=="running"&&(clearInterval(l),setTimeout(()=>{k(!1),S(null),h(),v()},3e3))},1e3)}catch{k(!1),S(null)}}async function J(s){i.size!==0&&(await m.post("/api/dashboard/bulk-action",{account_ids:Array.from(i),action:s}),_(new Set),N(null),v())}function Q(s){_(a=>{const l=new Set(a);return l.has(s)?l.delete(s):l.add(s),l})}function W(){i.size===f.length?_(new Set):_(new Set(f.map(s=>s.id)))}c.useEffect(()=>{Promise.all([h(),I()]).finally(()=>Y(!1))},[]),c.useEffect(()=>{v()},[o,y,D]);const B=Math.ceil(M/50),ee=t&&t.total>0?Math.max(2,t.scanned/t.total*100):5;return O?e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{className:"h-8 w-48"}),e.jsx(w,{className:"h-4 w-80"})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3",children:Array.from({length:7}).map((s,a)=>e.jsx(w,{className:"h-24 rounded-xl"},a))}),e.jsx(w,{className:"h-20 rounded-xl"}),e.jsx(w,{className:"h-96 rounded-xl"})]}):e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:"Dashboard"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Monitor dasher accounts, run scans, and manage onboarding stages."})]}),e.jsxs(te,{children:[e.jsx(ne,{asChild:!0,children:e.jsxs(d,{variant:"ghost",size:"icon",className:"relative",children:[e.jsx(re,{className:"h-5 w-5"}),((n==null?void 0:n.unread_alerts)||0)>0&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 flex h-4 min-w-4 items-center justify-center rounded-full bg-primary px-1 text-[10px] font-bold text-primary-foreground",children:n.unread_alerts>99?"99+":n.unread_alerts})]})}),e.jsxs(ce,{align:"end",className:"w-80",children:[e.jsxs("div",{className:"flex items-center justify-between px-2 py-1.5",children:[e.jsx("span",{className:"text-sm font-semibold",children:"Alerts"}),E.length>0&&e.jsx(d,{variant:"ghost",size:"sm",className:"h-auto px-2 py-1 text-xs text-primary",onClick:X,children:"Mark all read"})]}),e.jsx(le,{}),E.length===0?e.jsx("div",{className:"px-4 py-6 text-center text-muted-foreground text-sm",children:"No unread alerts"}):E.map(s=>e.jsxs(ie,{onClick:()=>K(s.id),className:"flex gap-3 items-start cursor-pointer py-2.5",children:[e.jsx("span",{className:`w-2 h-2 rounded-full mt-1.5 flex-shrink-0 ${Fe[s.severity]||"bg-muted-foreground"}`}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm font-medium",children:s.title}),s.message&&e.jsx("div",{className:"text-xs text-muted-foreground mt-0.5 truncate",children:s.message}),e.jsx("div",{className:"text-[10px] text-muted-foreground mt-1",children:new Date(s.created_at).toLocaleString()})]})]},s.id))]})]})]}),n&&e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3",children:xe.map(s=>{const a=o===s;return e.jsx(z,{className:`cursor-pointer transition-all hover:shadow-md ${a?"ring-2 ring-primary shadow-md":"hover:ring-1 hover:ring-border"}`,onClick:()=>A(o===s?{}:{stage:s}),children:e.jsxs(G,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex justify-center mb-2 text-muted-foreground",children:He[s]}),e.jsx("div",{className:"text-2xl font-bold",children:n.stage_counts[s]||0}),e.jsx("div",{className:"text-xs font-medium text-muted-foreground mt-1",children:L[s].label})]})},s)})}),!q&&e.jsx(z,{children:e.jsxs(G,{className:"p-5",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:[n!=null&&n.last_scan&&!u?e.jsxs(e.Fragment,{children:["Last scan:"," ",new Date(n.last_scan.started_at).toLocaleString()," —"," ",e.jsx("span",{className:`font-medium ${n.last_scan.status==="completed"?"text-emerald-600":n.last_scan.status==="failed"?"text-destructive":"text-foreground"}`,children:n.last_scan.status})," ","(",n.last_scan.scanned," scanned,"," ",n.last_scan.transitions," transitions)"]}):u?null:"No scans yet",u&&t&&e.jsx("span",{className:"font-medium text-foreground",children:t.status==="running"?t.total>0?`Scanning accounts... ${t.scanned}/${t.total}`:"Syncing SMTP accounts...":t.status==="completed"?"Scan completed!":"Scan failed"})]}),e.jsxs(d,{onClick:Z,disabled:u,children:[u&&e.jsx(_e,{className:"animate-spin"}),u?"Scanning...":"Scan All"]})]}),u&&t&&e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsxs("div",{className:"relative h-3 bg-secondary rounded-full overflow-hidden",children:[e.jsx("div",{className:`absolute inset-y-0 left-0 rounded-full transition-all duration-500 ease-out ${t.status==="completed"?"bg-emerald-500":"bg-primary"}`,style:{width:`${ee}%`}}),t.status==="running"&&e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent animate-[shimmer_1.5s_infinite]"})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-emerald-500"}),e.jsx("span",{className:"text-muted-foreground",children:"Scanned"}),e.jsx("span",{className:"font-bold",children:t.scanned})]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-blue-500"}),e.jsx("span",{className:"text-muted-foreground",children:"Transitions"}),e.jsx("span",{className:"font-bold",children:t.transitions})]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-destructive"}),e.jsx("span",{className:"text-muted-foreground",children:"Errors"}),e.jsx("span",{className:"font-bold",children:t.errors})]})]}),t.current_account&&t.status==="running"&&e.jsx("span",{className:"text-muted-foreground truncate max-w-[200px]",children:t.current_account})]})]})]})}),e.jsxs("div",{className:"flex gap-3 flex-wrap items-center",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(be,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(oe,{type:"text",placeholder:"Search by email...",defaultValue:y,className:"pl-10",onKeyDown:s=>{if(s.key==="Enter"){const a=s.target.value,l={};a&&(l.search=a),o&&(l.stage=o),A(l)}}})]}),e.jsxs("span",{className:"text-sm text-muted-foreground font-medium",children:[M," accounts"]}),!b&&i.size>0&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(d,{variant:"secondary",size:"sm",onClick:()=>N({action:"archive",label:"Archive"}),children:[e.jsx(De,{className:"h-3.5 w-3.5"}),"Archive (",i.size,")"]}),e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>N({action:"suspend",label:"Suspend"}),children:[e.jsx($e,{className:"h-3.5 w-3.5"}),"Suspend"]}),e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>N({action:"activate",label:"Activate"}),children:[e.jsx(Pe,{className:"h-3.5 w-3.5"}),"Activate"]})]})]}),e.jsx(z,{children:e.jsxs(pe,{children:[e.jsx(ge,{children:e.jsxs($,{children:[!b&&e.jsx(g,{className:"w-8",children:e.jsx("input",{type:"checkbox",checked:f.length>0&&i.size===f.length,onChange:W,className:"rounded accent-primary"})}),e.jsx(g,{children:"Email"}),e.jsx(g,{children:"Customer"}),e.jsx(g,{children:"Stage"}),e.jsx(g,{children:"Status"}),e.jsx(g,{children:"Stage Updated"}),e.jsx(g,{children:"Error"})]})}),e.jsxs(je,{children:[f.map(s=>{var a;return e.jsxs($,{children:[!b&&e.jsx(x,{children:e.jsx("input",{type:"checkbox",checked:i.has(s.id),onChange:()=>Q(s.id),className:"rounded accent-primary"})}),e.jsx(x,{children:e.jsx(de,{to:`/accounts/${encodeURIComponent(s.email)}`,className:"text-primary hover:text-primary/80 font-medium hover:underline",children:s.email})}),e.jsx(x,{className:"text-muted-foreground",children:s.first_name&&s.last_name?`${s.first_name} ${s.last_name}`:s.customer_name||"—"}),e.jsx(x,{children:e.jsx(V,{variant:"secondary",className:ue[s.stage]||"",children:((a=L[s.stage])==null?void 0:a.label)||s.stage})}),e.jsx(x,{children:e.jsx(V,{variant:"secondary",className:he[s.status]||"",children:s.status})}),e.jsx(x,{className:"text-muted-foreground text-sm",children:s.stage_updated_at?new Date(s.stage_updated_at).toLocaleString():"—"}),e.jsx(x,{className:"text-destructive max-w-xs truncate text-sm",children:s.scan_error||""})]},s.id)}),f.length===0&&e.jsx($,{children:e.jsx(x,{colSpan:b?6:7,className:"h-24 text-center text-muted-foreground",children:"No accounts found"})})]})]})}),B>1&&e.jsx("div",{className:"flex justify-center gap-1",children:Array.from({length:B},(s,a)=>a+1).map(s=>e.jsx(d,{variant:s===D?"default":"outline",size:"sm",onClick:()=>{const a={page:String(s)};o&&(a.stage=o),y&&(a.search=y),A(a)},children:s},s))}),e.jsx(fe,{open:!!r,onOpenChange:s=>!s&&N(null),children:e.jsxs(Ne,{children:[e.jsxs(ye,{children:[e.jsxs(ve,{children:["Confirm ",r==null?void 0:r.label]}),e.jsxs(we,{children:["Are you sure you want to ",r==null?void 0:r.action," ",i.size," selected account",i.size>1?"s":"","? This action cannot be easily undone."]})]}),e.jsxs(Se,{children:[e.jsx(d,{variant:"outline",onClick:()=>N(null),children:"Cancel"}),e.jsx(d,{variant:(r==null?void 0:r.action)==="activate"?"default":"destructive",onClick:()=>r&&J(r.action),children:r==null?void 0:r.label})]})]})})]})}export{ts as default};
